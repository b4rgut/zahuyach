<!-- Categories tree -->
<div class="categories-tree">
    {{#each categories}}
    <div class="category-node" data-category-slug="{{slug}}">
        <!-- Main category -->
        <div class="category-item {{#if is_active}}active{{/if}}">
            <div class="flex items-center justify-between group">
                <!-- Category toggle button -->
                <button
                    class="category-toggle flex items-center flex-1 py-2 px-3 text-left rounded-md hover:bg-gh-canvas-subtle transition-colors focus:outline-none focus:ring-2 focus:ring-gh-accent-emphasis"
                    onclick="toggleCategoryNode('{{slug}}')"
                    data-category="{{slug}}"
                    {{#if has_children}}
                    aria-expanded="{{#if is_expanded}}true{{else}}false{{/if}}"
                    {{/if}}
                >
                    <!-- Expand/collapse chevron -->
                    {{#if has_children}}
                    <svg
                        class="category-chevron w-4 h-4 mr-2 text-gh-fg-muted transform transition-transform duration-200 {{#if is_expanded}}rotate-90{{/if}}"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    {{else}}
                    <div class="w-4 h-4 mr-2"></div>
                    {{/if}}

                    <!-- Category icon -->
                    <svg class="w-4 h-4 mr-3 text-gh-fg-muted group-hover:text-gh-accent-fg transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {{#if has_children}}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        {{else}}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        {{/if}}
                    </svg>

                    <!-- Category name -->
                    <span class="flex-1 text-sm font-medium text-gh-fg-default group-hover:text-gh-accent-fg transition-colors truncate">
                        {{name}}
                    </span>
                </button>

                <!-- Category actions -->
                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <!-- Post count -->
                    <span class="text-xs text-gh-fg-subtle bg-gh-canvas-inset px-2 py-1 rounded-full min-w-[1.5rem] text-center">
                        {{posts_count}}
                    </span>

                    <!-- View category link -->
                    <a
                        href="/categories/{{slug}}"
                        class="p-1 text-gh-fg-muted hover:text-gh-accent-fg hover:bg-gh-canvas-subtle rounded transition-colors"
                        title="Просмотреть все статьи в категории «{{name}}»"
                        hx-get="/api/posts/category/{{slug}}"
                        hx-target="#posts-container"
                        hx-push-url="true"
                        hx-indicator="#htmx-indicator"
                    >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Subcategories and posts -->
        {{#if has_children}}
        <div
            class="category-children ml-6 pl-4 border-l border-gh-border-muted {{#unless is_expanded}}hidden{{/unless}}"
            data-category-children="{{slug}}"
        >
            <!-- Subcategories -->
            {{#if subcategories}}
            <div class="subcategories space-y-1 mt-2">
                {{#each subcategories}}
                <div class="subcategory-item">
                    <a
                        href="/categories/{{../slug}}/{{slug}}"
                        class="flex items-center justify-between py-1.5 px-3 rounded-md text-sm text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle transition-colors group"
                        hx-get="/api/posts/category/{{../slug}}/{{slug}}"
                        hx-target="#posts-container"
                        hx-push-url="true"
                        hx-indicator="#htmx-indicator"
                        title="{{description}}"
                    >
                        <div class="flex items-center flex-1 min-w-0">
                            <!-- Subcategory icon -->
                            <svg class="w-3 h-3 mr-2 text-gh-fg-subtle group-hover:text-gh-accent-fg transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="truncate">{{name}}</span>
                        </div>
                        <span class="text-xs text-gh-fg-subtle ml-2 flex-shrink-0">{{posts_count}}</span>
                    </a>
                </div>
                {{/each}}
            </div>
            {{/if}}

            <!-- Direct posts in category -->
            {{#if has_direct_posts}}
            <div class="direct-posts mt-3">
                <a
                    href="/categories/{{slug}}/posts"
                    class="flex items-center justify-between py-1.5 px-3 rounded-md text-sm text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle transition-colors group"
                    hx-get="/api/posts/category/{{slug}}/direct"
                    hx-target="#posts-container"
                    hx-push-url="true"
                    hx-indicator="#htmx-indicator"
                >
                    <div class="flex items-center">
                        <!-- Direct posts icon -->
                        <svg class="w-3 h-3 mr-2 text-gh-fg-subtle group-hover:text-gh-accent-fg transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span class="italic">Статьи в категории</span>
                    </div>
                    <span class="text-xs text-gh-fg-subtle">{{direct_posts_count}}</span>
                </a>
            </div>
            {{/if}}

            <!-- Nested subcategories (recursive) -->
            {{#if nested_subcategories}}
            <div class="nested-categories mt-2">
                {{#each nested_subcategories}}
                {{> categories_tree categories=this}}
                {{/each}}
            </div>
            {{/if}}
        </div>
        {{/if}}
    </div>
    {{/each}}
</div>

<!-- Empty state for categories -->
{{#unless categories}}
<div class="empty-categories text-center py-8">
    <div class="mx-auto w-16 h-16 bg-gh-canvas-subtle rounded-full flex items-center justify-center mb-4">
        <svg class="w-8 h-8 text-gh-fg-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
        </svg>
    </div>
    <h4 class="text-sm font-medium text-gh-fg-default mb-2">Категории не найдены</h4>
    <p class="text-xs text-gh-fg-muted">Статьи еще не были организованы по категориям</p>
</div>
{{/unless}}

<style>
/* Category tree specific styles */
.categories-tree {
    @apply space-y-1;
}

.category-node {
    @apply relative;
}

.category-item.active > div > .category-toggle {
    @apply bg-gh-accent-subtle text-gh-accent-fg;
}

.category-item.active > div > .category-toggle .category-chevron,
.category-item.active > div > .category-toggle svg {
    @apply text-gh-accent-fg;
}

.category-children {
    @apply transition-all duration-300 ease-in-out;
}

.category-children.hidden {
    @apply opacity-0 max-h-0 overflow-hidden;
}

.category-children:not(.hidden) {
    @apply opacity-100 max-h-screen;
}

.category-chevron.rotate-90 {
    transform: rotate(90deg);
}

/* Hover effects for better UX */
.category-toggle:hover .category-chevron {
    @apply text-gh-accent-fg;
}

.category-toggle:focus {
    @apply ring-2 ring-gh-accent-emphasis ring-offset-2 ring-offset-gh-canvas-default;
}

/* Subcategory indentation lines */
.category-children::before {
    content: '';
    @apply absolute left-0 top-0 bottom-0 w-px bg-gh-border-muted;
}

/* Animation for category expansion */
@keyframes expandCategory {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 500px;
    }
}

@keyframes collapseCategory {
    from {
        opacity: 1;
        max-height: 500px;
    }
    to {
        opacity: 0;
        max-height: 0;
    }
}

.category-children:not(.hidden) {
    animation: expandCategory 0.3s ease-out forwards;
}

.category-children.hidden {
    animation: collapseCategory 0.3s ease-out forwards;
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .category-children {
        @apply ml-4 pl-3;
    }
}

/* Search highlighting */
.category-node.search-highlight {
    @apply bg-gh-accent-subtle bg-opacity-20 rounded-md;
}

.category-node.search-highlight .category-toggle {
    @apply text-gh-accent-fg;
}

/* Loading states */
.category-loading {
    @apply opacity-50 pointer-events-none;
}

.category-loading .category-toggle::after {
    content: '';
    @apply absolute right-2 top-1/2 transform -translate-y-1/2;
    @apply w-3 h-3 border border-gh-accent-fg border-t-transparent rounded-full animate-spin;
}
</style>

<script>
// Category tree functionality
function toggleCategoryNode(categorySlug) {
    const categoryNode = document.querySelector(`[data-category-slug="${categorySlug}"]`);
    const children = document.querySelector(`[data-category-children="${categorySlug}"]`);
    const chevron = categoryNode?.querySelector('.category-chevron');
    const toggleButton = categoryNode?.querySelector('.category-toggle');

    if (!children) return;

    const isExpanded = !children.classList.contains('hidden');

    if (isExpanded) {
        // Collapse
        children.classList.add('hidden');
        chevron?.classList.remove('rotate-90');
        toggleButton?.setAttribute('aria-expanded', 'false');

        // Save state
        saveCategoryState(categorySlug, false);
    } else {
        // Expand
        children.classList.remove('hidden');
        chevron?.classList.add('rotate-90');
        toggleButton?.setAttribute('aria-expanded', 'true');

        // Save state
        saveCategoryState(categorySlug, true);
    }
}

// Save category expand/collapse state
function saveCategoryState(categorySlug, isExpanded) {
    const expandedCategories = JSON.parse(localStorage.getItem('expandedCategories') || '[]');

    if (isExpanded && !expandedCategories.includes(categorySlug)) {
        expandedCategories.push(categorySlug);
    } else if (!isExpanded) {
        const index = expandedCategories.indexOf(categorySlug);
        if (index > -1) {
            expandedCategories.splice(index, 1);
        }
    }

    localStorage.setItem('expandedCategories', JSON.stringify(expandedCategories));
}

// Restore category states on page load
function restoreCategoryStates() {
    const expandedCategories = JSON.parse(localStorage.getItem('expandedCategories') || '[]');

    expandedCategories.forEach(categorySlug => {
        const children = document.querySelector(`[data-category-children="${categorySlug}"]`);
        const chevron = document.querySelector(`[data-category="${categorySlug}"] .category-chevron`);
        const toggleButton = document.querySelector(`[data-category="${categorySlug}"]`);

        if (children) {
            children.classList.remove('hidden');
            chevron?.classList.add('rotate-90');
            toggleButton?.setAttribute('aria-expanded', 'true');
        }
    });
}

// Initialize category states when the tree is loaded
document.addEventListener('DOMContentLoaded', restoreCategoryStates);

// Handle HTMX events to restore states after dynamic updates
document.addEventListener('htmx:afterSettle', function(event) {
    if (event.target.id === 'categories-tree') {
        restoreCategoryStates();
    }
});
</script>
