<!-- Main sidebar -->
<div class="sidebar-content h-full flex flex-col bg-gh-canvas-overlay">
    <!-- Sidebar header -->
    <div class="sidebar-header p-6 border-b border-gh-border-default">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gh-fg-default">Навигация</h2>
            <button
                class="lg:hidden p-2 text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle rounded-md transition-colors"
                onclick="closeSidebar()"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Quick stats -->
        <div class="grid grid-cols-2 gap-4 text-center">
            <div class="bg-gh-canvas-inset rounded-lg p-3">
                <div class="text-lg font-semibold text-gh-fg-default">{{stats.total_posts}}</div>
                <div class="text-xs text-gh-fg-muted">Статей</div>
            </div>
            <div class="bg-gh-canvas-inset rounded-lg p-3">
                <div class="text-lg font-semibold text-gh-fg-default">{{stats.total_categories}}</div>
                <div class="text-xs text-gh-fg-muted">Категорий</div>
            </div>
        </div>
    </div>

    <!-- Navigation menu -->
    <div class="sidebar-nav p-6 border-b border-gh-border-default">
        <nav class="space-y-2">
            <a
                href="/"
                class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle transition-colors"
                hx-get="/api/posts/latest"
                hx-target="#posts-container"
                hx-push-url="true"
            >
                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                </svg>
                Последние статьи
            </a>

            <a
                href="/popular"
                class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle transition-colors"
                hx-get="/api/posts/popular"
                hx-target="#posts-container"
                hx-push-url="true"
            >
                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Популярные
            </a>

            <a
                href="/bookmarks"
                class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle transition-colors"
                onclick="showBookmarks()"
            >
                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
                Закладки
                <span id="bookmarks-count" class="ml-auto text-xs bg-gh-canvas-inset text-gh-fg-subtle px-2 py-0.5 rounded-full">0</span>
            </a>

            <a
                href="/archive"
                class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium text-gh-fg-muted hover:text-gh-fg-default hover:bg-gh-canvas-subtle transition-colors"
            >
                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                </svg>
                Архив
            </a>
        </nav>
    </div>

    <!-- Categories section -->
    <div class="categories-section flex-1 overflow-hidden">
        {{> categories_sidebar}}
    </div>

    <!-- Popular tags -->
    <div class="popular-tags p-6 border-t border-gh-border-default">
        <h3 class="text-sm font-semibold text-gh-fg-default mb-3">Популярные теги</h3>
        <div class="flex flex-wrap gap-2">
            {{#each popular_tags}}
            <button
                class="tag-filter inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gh-canvas-subtle text-gh-fg-muted hover:bg-gh-accent-subtle hover:text-gh-accent-fg border border-gh-border-default hover:border-gh-accent-emphasis transition-all cursor-pointer"
                data-tag="{{name}}"
                title="{{count}} статей с тегом «{{name}}»"
                hx-get="/api/posts/tag/{{name}}"
                hx-target="#posts-container"
                hx-push-url="true"
            >
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                {{name}}
                <span class="ml-1 text-xs bg-gh-canvas-inset text-gh-fg-subtle px-1 rounded">{{count}}</span>
            </button>
            {{/each}}
        </div>
        <div class="mt-3">
            <a
                href="/tags"
                class="inline-flex items-center text-xs text-gh-accent-fg hover:text-gh-accent-muted transition-colors"
            >
                Все теги
                <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
    </div>

    <!-- Recent activity -->
    <div class="recent-activity p-6 border-t border-gh-border-default">
        <h3 class="text-sm font-semibold text-gh-fg-default mb-3">Недавняя активность</h3>
        <div class="space-y-3">
            {{#each recent_posts}}
            <div class="group">
                <a
                    href="/posts/{{slug}}"
                    class="block text-sm text-gh-fg-muted group-hover:text-gh-fg-default transition-colors line-clamp-2 leading-snug"
                    title="{{title}}"
                >
                    {{title}}
                </a>
                <div class="flex items-center justify-between mt-1 text-xs text-gh-fg-subtle">
                    <time datetime="{{date_iso}}">{{date_short}}</time>
                    {{#if reading_time}}
                    <span>{{reading_time}} мин</span>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>

    <!-- Sidebar footer -->
    <div class="sidebar-footer p-6 border-t border-gh-border-default">
        <div class="text-center">
            <div class="text-xs text-gh-fg-muted mb-2">
                Последнее обновление: {{last_updated}}
            </div>
            <div class="flex justify-center space-x-3">
                {{#if site.rss_enabled}}
                <a
                    href="/feed.xml"
                    class="text-gh-fg-muted hover:text-gh-accent-fg transition-colors"
                    title="RSS Feed"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/>
                    </svg>
                </a>
                {{/if}}

                {{#if site.github}}
                <a
                    href="{{site.github}}"
                    class="text-gh-fg-muted hover:text-gh-accent-fg transition-colors"
                    title="GitHub"
                    target="_blank"
                    rel="noopener noreferrer"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<style>
.sidebar-content {
    min-height: 100vh;
}

.nav-item.active {
    @apply bg-gh-accent-subtle text-gh-accent-fg;
}

.nav-item.active svg {
    @apply text-gh-accent-fg;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Scrollbar styling for sidebar sections */
.categories-section ::-webkit-scrollbar,
.recent-activity ::-webkit-scrollbar {
    width: 4px;
}

.categories-section ::-webkit-scrollbar-track,
.recent-activity ::-webkit-scrollbar-track {
    @apply bg-transparent;
}

.categories-section ::-webkit-scrollbar-thumb,
.recent-activity ::-webkit-scrollbar-thumb {
    @apply bg-gh-border-default rounded-full;
}

.categories-section ::-webkit-scrollbar-thumb:hover,
.recent-activity ::-webkit-scrollbar-thumb:hover {
    @apply bg-gh-border-muted;
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .sidebar-content {
        min-height: auto;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update bookmark count
    updateBookmarkCount();

    // Set active navigation item based on current URL
    setActiveNavItem();

    // Update stats periodically (if needed)
    updateStats();
});

// Update bookmark count
function updateBookmarkCount() {
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    const countElement = document.getElementById('bookmarks-count');
    if (countElement) {
        countElement.textContent = bookmarks.length;
        countElement.style.display = bookmarks.length > 0 ? 'inline' : 'none';
    }
}

// Set active navigation item
function setActiveNavItem() {
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll('.nav-item');

    navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('href') === currentPath) {
            item.classList.add('active');
        }
    });
}

// Show bookmarks
function showBookmarks() {
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    if (bookmarks.length === 0) {
        showNotification('У вас пока нет закладок');
        return;
    }

    // Load bookmarked posts
    htmx.ajax('POST', '/api/posts/bookmarks', {
        target: '#posts-container',
        values: { slugs: bookmarks.join(',') }
    });
}

// Close sidebar (mobile)
function closeSidebar() {
    const sidebar = document.querySelector('.sidebar-content').closest('aside');
    if (sidebar) {
        sidebar.style.transform = 'translateX(-100%)';
    }
}

// Update stats (if dynamic updates are needed)
function updateStats() {
    // This could periodically update stats via HTMX
    // htmx.ajax('GET', '/api/stats', { target: '.sidebar-header .grid' });
}

// Listen for bookmark changes
document.addEventListener('bookmarkChanged', function() {
    updateBookmarkCount();
});

// Listen for navigation changes
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'posts-container') {
        setActiveNavItem();
    }
});

// Handle tag filter clicks
document.addEventListener('click', function(e) {
    if (e.target.matches('.tag-filter') || e.target.closest('.tag-filter')) {
        // Add visual feedback for tag selection
        const tagButton = e.target.matches('.tag-filter') ? e.target : e.target.closest('.tag-filter');
        tagButton.classList.add('animate-pulse');
        setTimeout(() => {
            tagButton.classList.remove('animate-pulse');
        }, 500);
    }
});

// Show notification helper
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 bg-gh-canvas-overlay border border-gh-border-default rounded-lg px-4 py-2 shadow-lg transform translate-x-full transition-transform duration-300`;

    const iconMap = {
        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
        warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"/>'
    };

    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <svg class="w-4 h-4 text-gh-${type === 'success' ? 'success' : type === 'warning' ? 'attention' : 'accent'}-fg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${iconMap[type] || iconMap.info}
            </svg>
            <span class="text-sm text-gh-fg-default">${message}</span>
        </div>
    `;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 10);

    // Animate out and remove
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}
</script>
